var items=["Item 0 Title","Item 1 Title","Item 2 Title","Item 3 Title","Item 4 Title","Item 5 Title","Item 6 Title","Item 7 Title"],info=["This is a popup containing the information about auction number 0","This is a popup containing the information about auction number 1","This is a popup containing the information about auction number 2","This is a popup containing the information about auction number 3","This is a popup containing the information about auction number 4","This is a popup containing the information about auction number 5","This is a popup containing the information about auction number 6","This is a popup containing the information about auction number 7"];firstNight=[0,1,3,5,7],secondNight=[0,1,2,4,6],minimumBid=[55,60,20,0,4,0,99,0];var numberOfItems=items.length,endDate1=new Date(2020,8,27,21,29),endDate2=new Date(2020,8,28,21,29);console.log("Auctions will end:\n"+endDate1+"\n"+endDate2);for(var endTime1=endDate1.getTime()/1e3,endTime2=endDate2.getTime()/1e3,endTimes=[],startPrices=[],i=0;i<numberOfItems;i++)secondNight.includes(i)?endTimes.push(endTime2):endTimes.push(endTime1),startPrices.push({bid0:{bidder:String(i),amount:minimumBid[i],time:Date().substring(0,24)}});function timeRemaining(i){var e=i-(new Date).getTime()/1e3;return parseInt(e/3600)+"h "+parseInt(e/60)%60+"m "+parseInt(e%60,10)+"s"}function setClocks(){for(i=0;i<numberOfItems;i++){timeLeft=timeRemaining(endTimes[i]);var e=$("#timeRemaining"+i)[0];timeLeft.includes("-")?(e.innerHTML="Auction Complete",$("#bidButton"+i).attr("disabled","")):e.innerHTML="Auction Ends:<br/>"+timeLeft}setTimeout(setClocks,1e3)}function placeBid(e){if(13==e.which||13==e.keyCode||1==e.which){e.preventDefault(),console.log("Cleaning input");var t=$("#checkbox-1").is(".is-checked"),n=Number($("#text2")[0].value);if(!t&&0==n){console.log("No amount or confirm");var o=$("#textfield1")[0];return $("#bid-error")[0].innerHTML="Please enter and confirm an amount!",void o.classList.add("is-invalid","is-dirty")}if(0==n){console.log("No amount");o=$("#textfield1")[0];return $("#bid-error")[0].innerHTML="Please enter an amount!",void o.classList.add("is-invalid","is-dirty")}if(!/^-?\d*[.,]?\d{0,2}$/.test(n)){console.log("Not money");o=$("#textfield1")[0];return $("#bid-error")[0].innerHTML="Input is not a valid amount of money!",void o.classList.add("is-invalid","is-dirty")}if(!t){console.log("No confirm");o=$("#textfield1")[0];return $("#bid-error")[0].innerHTML="Please confirm your bid!",void o.classList.add("is-invalid","is-dirty")}console.log("Checking if bid is high enough");var a=$(".bid-form")[0].classList;for(i=0;i<a.length;++i)var s=a[i].match(/bidButton[0-9]+/);var r=auth.currentUser,d=s[0].substring(9),c=(d.toString().length<2?"0"+d:d)+" - "+items[d],l=db.collection("auction-live").doc("items"),u=db.collection("auction-store").doc(c);l.get().then(function(i){console.log("Database read from placeBid()");var t=i.data()[c],o=(Object.keys(t).length-1)/2,a="bid"+o;if(!(n>=1+t[a])){var s=$("#textfield1")[0];return $("#bid-error")[0].innerHTML="You must bid at least £"+(1+t[a]).toFixed(2)+"!",s.classList.add("is-invalid","is-dirty"),void console.info("Must be highest bid so far")}dotBidder=c+".bid"+(o+1)+"-user",dotKey=c+".bid"+(o+1),l.update({[dotBidder]:r.uid,[dotKey]:n}),console.log("Database write from placeBid()"),storeKey="bid"+(o+1),u.update({[storeKey]:{bidder:r.displayName,amount:n,time:Date().substring(0,24)}}),console.log("Database write from placeBid()"),$("#text2")[0].value="",$("#textfield1")[0].classList.remove("is-invalid","is-dirty"),$("#checkbox-1")[0].classList.remove("is-checked"),closeFAB(e)}),console.info("Bid placed")}}function generateItems(){for(i=0;i<numberOfItems;i++){var e=document.createElement("div"),t=document.createElement("h5"),n=document.createElement("img"),o=document.createElement("h6"),a=document.createElement("div"),s=document.createElement("button"),r=document.createElement("button"),d=document.createElement("h6"),c=document.createElement("h6");e.classList.add("mdl-cell","mdl-cell--2-col-phone","mdl-cell--4-col-tablet","mdl-cell--6-col","mdl-shadow--2dp"),e.id="auction"+i,o.classList.add("current-bid"+i),d.classList.add("bids"+i),a.classList.add("btn-wrapper"),s.classList.add("mdl-button","mdl-js-button","mdl-button--raised","bid-button","fab"),r.classList.add("mdl-button","mdl-js-button","mdl-button--raised","info-button"),c.classList.add("auction-timer"),t.innerHTML=items[i],n.src="./img/item"+i+".jpg",s.innerHTML="Bid Now",r.innerHTML="Info",a.id="auctionButtons",s.id="bidButton"+i,r.id="infoButton"+i,n.id="infoImages"+i,s.onclick=function(){openBid(this.id)},r.onclick=function(){openInfo(this.id)},n.onclick=function(){openInfo(this.id)},o.innerHTML="Current Bid: £-.--",d.innerHTML="Bids: -",c.id="timeRemaining"+i,e.appendChild(t),e.appendChild(n),e.appendChild(o),e.appendChild(a),a.appendChild(r),a.appendChild(s),e.appendChild(d),e.appendChild(c),auctionGrid=$("#auction-grid")[0],auctionGrid.appendChild(e)}}function dataListener(){var i=(new Date).getDay();5==i?secondNight.filter(i=>!firstNight.includes(i)).forEach(function(i){$("#auction"+i).css({display:"none"})}):6==i&&firstNight.filter(i=>!secondNight.includes(i)).forEach(function(i){$("#auction"+i).css({display:"none"})}),db.collection("auction-live").doc("items").onSnapshot(function(i){console.log("Database read from dataListener()");var e=i.data();for(var t in e){var n=e[t],o=Number(t.substring(0,2)),a=$(".current-bid"+o)[0],s=$(".bids"+o)[0],r=(Object.keys(n).length-1)/2,d=n["bid"+r],c=Number.parseFloat(d).toFixed(2);if(auth.currentUser)var l=n["bid"+r+"-user"]==auth.currentUser.uid;a.innerHTML="Current Bid: £"+c,s.innerHTML="Bids: "+r+(l?" (Winning)":"")}})}function resetLive(){console.log("Resetting live tracker");var e=db.collection("auction-live").doc("items"),t="00 - "+items[0];for(e.set({[t]:{bid0:startPrices[0].bid0.amount}}),console.log("Database write from resetLive()"),i=1;i<numberOfItems;i++){t=(i.toString().length<2?"0"+i:i)+" - "+items[i];e.update({[t]:{bid0:startPrices[i].bid0.amount}}),console.log("Database write from resetLive()")}}function resetStore(){console.log("Resetting auction storage");var e=db.batch();for(i=0;i<numberOfItems;i++){var t=(i.toString().length<2?"0"+i:i)+" - "+items[i],n=db.collection("auction-store").doc(t);e.set(n,startPrices[i])}e.commit(),console.log(numberOfItems+" database writes from resetStore()")}function resetAll(){resetLive(),resetStore()}
function autoLogin(){auth.onAuthStateChanged(function(e){e?null!=e.displayName?(console.log("Return user: "+e.displayName+" ("+e.uid+")"),insertName(e.displayName)):console.log("New user, signed in"):(console.log("New user, creating account"),auth.signInAnonymously())})}function newUserLogin(e){if((13==e.which||13==e.keyCode||1==e.which)&&(e.preventDefault(),loggedIn=auth.currentUser&&auth.currentUser.displayName,!loggedIn)){var n=$("#text1")[0].value,i=$("#table-number")[0].value;if(""==n&&""==i){console.log("No name entered or table selected"),$("#full-name")[0].classList.add("is-invalid","is-dirty");var a=$("#table-number-box")[0];return console.log(a),void a.classList.add("is-invalid","is-dirty")}if(""==n)return console.log("No name entred"),void $("#full-name")[0].classList.add("is-invalid","is-dirty");if(""==i)return console.log("No table selected"),void $("#table-number-box")[0].classList.add("is-invalid","is-dirty");insertName(n);var o=auth.currentUser;o.updateProfile({displayName:n}),db.collection("users").doc(o.uid).set({name:n,table:i,admin:"false"}),console.log("Database wwrite from newUserLogin()"),closeFAB(e),console.log("User name added: "+n+" ("+o.uid+")")}}function insertName(e){firstName=e.replace(/ .*/,""),loginIndicator=$("#login-indicator1")[0],loginIndicator.innerHTML="Hi "+firstName,btnSignIn=$(".login-button .mdl-navigation__link")[0],btnSignIn.style.display="none"}
var overlay=$("#overlay"),fabLogin=$(".fab.login-button"),fabLoginForm=$(".fab.login-form"),fabBid=$(".fab.bid-button"),fabInfo=$(".fab.info-button"),fabBidForm=$(".fab.bid-form"),fabInfoPage=$(".fab.info-page"),cancel=$("#cancel"),submit=$("#submit");function openLogin(e){console.log("Login popup"),loggedIn=auth.currentUser&&auth.currentUser.displayName,loggedIn?console.log("Already logged in"):(e&&e.preventDefault(),fabLoginForm.addClass("active"),overlay.addClass("dark-overlay"))}function openBid(e){console.log("Bid popup from "+e),itemTitle=items[e.replace("bidButton","")],$(".bid-form #fab-hdr h4")[0].innerHTML=itemTitle,loggedIn=auth.currentUser&&auth.currentUser.displayName,loggedIn?(event&&event.preventDefault(),fabBidForm.addClass("active"),fabBidForm.addClass(e),overlay.addClass("dark-overlay")):loginWarning()}function openInfo(e){console.log("Info popup from "+e),itemNumber=e.substring(10),extraImages=[0,1,5,6,7],extraImages.includes(Number(itemNumber))?$("#info-content img")[0].src="./img/item"+itemNumber+"-extra.jpg":$("#info-content img")[0].src="",itemTitle=items[itemNumber],itemInfo=info[itemNumber],$("#fab-hdr-info h3")[0].innerHTML=itemTitle,$("form div p")[0].innerHTML=itemInfo,event&&event.preventDefault(),fabInfoPage.addClass("active"),$("#info-content").scrollTop(0),overlay.addClass("dark-overlay"),$("#info-content").css("max-height","calc(70vh - "+$("#fab-hdr-info").height()+"px)")}function closeFAB(e){e&&(e.preventDefault(),e.stopImmediatePropagation()),fabLoginForm.removeClass("active"),fabInfoPage.removeClass("active"),fabBidForm.removeClass("active"),fabBidForm.removeClass(function(e,o){return(o.match(/(^|\s)bidButton\S+/g)||[]).join(" ")}),overlay.removeClass("dark-overlay")}function loginWarning(){var e=$("#login-prompt")[0],o=($(".bid-button")[0],{message:"Please log in first.",timeout:4e3,actionHandler:function(e){$("#login-prompt")[0].classList.remove("mdl-snackbar--active"),openLogin()},actionText:"Log in"});e.MaterialSnackbar.showSnackbar(o)}fabLogin.on("click",openLogin),overlay.on("click",closeFAB),cancel.on("click",closeFAB);